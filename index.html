<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlmoEarth Embeddings - Bangalore Ward Analysis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0e1a;
            color: #e2e8f0;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #sidebar {
            width: 400px;
            background: linear-gradient(180deg, #0f1419 0%, #1a1f2e 100%);
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #header {
            padding: 28px 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
        }

        h1 {
            font-size: 22px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 13px;
            color: #94a3b8;
            font-weight: 500;
        }

        #stats {
            padding: 24px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.6) 100%);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 14px;
            padding: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #6366f1 0%, #a78bfa 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #818cf8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #controls {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 28px;
        }

        .control-label {
            font-size: 12px;
            color: #cbd5e1;
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Enhanced Sidebar Navigation for Metrics */
        .metric-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .metric-item {
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            color: #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-item:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: translateX(4px);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .metric-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.2) 0%, rgba(30, 41, 59, 0.4) 100%);
            border-color: #6366f1;
            color: #818cf8;
            font-weight: 600;
        }

        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-item:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .toggle-item input[type="checkbox"],
        .toggle-item input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #6366f1;
        }

        .toggle-item label {
            font-size: 14px;
            color: #e2e8f0;
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }

        .status-complete {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .status-both {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            border: 1px solid rgba(99, 102, 241, 0.4);
        }

        #map {
            flex: 1;
            position: relative;
            background: #0f1419;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(16px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 240px;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        .legend-color {
            width: 28px;
            height: 18px;
            border-radius: 6px;
            margin-right: 12px;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .ward-info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(16px);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 320px;
            max-width: 400px;
            display: none;
        }

        .ward-info-panel.active {
            display: block;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .info-title {
            font-size: 18px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 6px;
        }

        .info-subtitle {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            font-size: 13px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #94a3b8;
            font-weight: 500;
        }

        .info-value {
            color: #e2e8f0;
            font-weight: 600;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 5px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #94a3b8;
            z-index: 2000;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="sidebar">
            <div id="header">
                <h1>üåç URBAN DATA INSIGHTS</h1>
                <div class="subtitle">Embedding & Prediction Visualization</div>
            </div>

            <div id="stats">
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Wards Analyzed</div>
                        <div class="stat-value" id="wards-processed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Wards</div>
                        <div class="stat-value">198</div>
                    </div>
                </div>
            </div>

            <div id="controls">
                <div class="control-section">
                    <span class="control-label">Analysis Metrics</span>
                    <div class="metric-list" id="metric-list">
                        <div class="metric-item active" onclick="selectMetric('status')">
                            <span>Data Availability Status</span>
                        </div>
                        <div class="metric-item" onclick="selectMetric('vegetation')">
                            <span>Vegetation Index</span>
                        </div>
                        <div class="metric-item" onclick="selectMetric('urban_density')">
                            <span>Urban Density</span>
                        </div>
                        <div class="metric-item" onclick="selectMetric('diversity')">
                            <span>Feature Diversity</span>
                        </div>
                        <div class="metric-item" onclick="selectMetric('veg_change')">
                            <span>Vegetation Change</span>
                        </div>
                        <div class="metric-item" onclick="selectMetric('urban_change')">
                            <span>Urban Density Change</span>
                        </div>
                        <div class="metric-item" onclick="selectMetric('diversity_change')">
                            <span>Diversity Change</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Layers</span>
                    <div class="toggle-group">
                        <div class="toggle-item">
                            <input type="checkbox" id="show-osm" onchange="toggleLayer('osm')">
                            <label for="show-osm">OpenStreetMap Overlay</label>
                        </div>
                        <div class="toggle-item">
                            <input type="checkbox" id="show-satellite" onchange="toggleLayer('satellite')">
                            <label for="show-satellite">Satellite Imagery</label>
                        </div>
                        <div class="toggle-item">
                            <input type="checkbox" id="show-wards" checked onchange="toggleLayer('wards')">
                            <label for="show-wards">Ward Boundaries & Labels</label>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Time Selection</span>
                    <div class="toggle-group">
                        <div class="toggle-item">
                            <input type="radio" name="time" id="time-2019" value="2019" onchange="updateTime('2019')">
                            <label for="time-2019">2019 Baseline</label>
                        </div>
                        <div class="toggle-item">
                            <input type="radio" name="time" id="time-2024" value="2024" checked
                                onchange="updateTime('2024')">
                            <label for="time-2024">2024 Current</label>
                        </div>
                        <div class="toggle-item">
                            <input type="radio" name="time" id="time-both" value="both" onchange="updateTime('both')">
                            <label for="time-both">Change Analysis (Both)</label>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <span class="control-label">Layer Opacity</span>
                    <input type="range" id="opacity-slider" min="0" max="100" value="70"
                        style="width: 100%; accent-color: #6366f1;" oninput="updateOpacity(this.value)">
                </div>
            </div>
        </div>
        <div id="map">
            <div class="loading" id="loading">Loading ward data...</div>
        </div>

        <div class="legend">
            <div class="legend-title" id="legend-title">Data Availability</div>
            <div id="legend-content"></div>
        </div>

        <div class="ward-info-panel" id="ward-info-panel">
            <div class="info-title" id="info-ward-name">Ward Name</div>
            <div class="info-subtitle" id="info-ward-code">Ward Code</div>
            <div id="info-content"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let wardMapping = null;
        let detailedAnalysis = null;
        let currentYear = '2024';
        let currentMetric = 'status';
        let metricRanges = {};

        // Initialize map
        const map = L.map('map', {
            zoomControl: true,
            zoomAnimation: true,
            fadeAnimation: true
        }).setView([12.9716, 77.5946], 12); // Bangalore Center

        // Create Panes for proper layering
        // 1. Tile Pane (default z-index 200) - Dark Matter
        // 2. Satellite Pane (z-index 250) - So it covers Dark Matter when enabled
        // 3. Overlay Pane (z-index 400) - For OSM Overlay
        // 4. Wards Pane (z-index 450) - Ensure Wards are always on top

        map.createPane('satellitePane');
        map.getPane('satellitePane').style.zIndex = 250;

        map.createPane('osmPane');
        map.getPane('osmPane').style.zIndex = 300;
        // set opacity for OSM to overlay smoothly
        map.getPane('osmPane').style.opacity = 0.6;

        map.createPane('wardsPane');
        map.getPane('wardsPane').style.zIndex = 450;

        // Base Layer (Dark)
        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 20
        }).addTo(map);

        // Satellite Layer (Initially OFF)
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri',
            maxZoom: 19,
            pane: 'satellitePane'
        });

        // OSM Overlay Layer (Initially OFF)
        const osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            pane: 'osmPane',
            attribution: '&copy; OpenStreetMap'
        });

        let wardLayer = null;

        // Load data
        Promise.all([
            fetch('ward_mapping.json').then(r => r.json()),
            fetch('ward_detailed_analysis.json').then(r => r.json())
        ]).then(([mapping, detailed]) => {
            wardMapping = mapping;
            detailedAnalysis = detailed;

            calculateMetricRanges();
            loadWards();
            updateStats();
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('loading').textContent = 'Error loading data. Run analysis scripts first.';
        });

        function calculateMetricRanges() {
            if (!detailedAnalysis || !detailedAnalysis.wards) return;

            const metrics = ['vegetation_index', 'urban_density', 'feature_diversity'];
            const changes = ['vegetation_change_percent', 'urban_density_change_percent', 'diversity_change_percent'];

            // Initialize ranges
            [...metrics, ...changes].forEach(m => {
                metricRanges[m] = { min: Infinity, max: -Infinity };
            });

            detailedAnalysis.wards.forEach(w => {
                if (w.metrics_2019) updateRange(w.metrics_2019, metrics);
                if (w.metrics_2024) updateRange(w.metrics_2024, metrics);

                if (w.change_metrics) {
                    changes.forEach(key => {
                        const val = w.change_metrics[key];
                        if (val !== undefined && val !== null) {
                            metricRanges[key].min = Math.min(metricRanges[key].min, val);
                            metricRanges[key].max = Math.max(metricRanges[key].max, val);
                        }
                    });
                }
            });
        }

        function updateRange(sourceObj, keys) {
            keys.forEach(key => {
                const val = sourceObj[key];
                if (val !== undefined && val !== null) {
                    metricRanges[key].min = Math.min(metricRanges[key].min, val);
                    metricRanges[key].max = Math.max(metricRanges[key].max, val);
                }
            });
        }

        function getMetricValue(wardId) {
            const detailedWard = detailedAnalysis?.wards.find(w => w.ward_id === wardId);
            if (!detailedWard) return null;

            switch (currentMetric) {
                case 'vegetation':
                    return detailedWard.metrics_2024?.vegetation_index ?? detailedWard.metrics_2019?.vegetation_index;
                case 'urban_density':
                    return detailedWard.metrics_2024?.urban_density ?? detailedWard.metrics_2019?.urban_density;
                case 'diversity':
                    return detailedWard.metrics_2024?.feature_diversity ?? detailedWard.metrics_2019?.feature_diversity;
                case 'veg_change':
                    return detailedWard.change_metrics?.vegetation_change_percent;
                case 'urban_change':
                    return detailedWard.change_metrics?.urban_density_change_percent;
                case 'diversity_change':
                    return detailedWard.change_metrics?.diversity_change_percent;
                default:
                    return null;
            }
        }

        function interpolateColor(color1, color2, factor) {
            if (arguments.length < 3) return color1;
            let result = "#";
            for (let i = 1; i <= 6; i += 2) {
                let c1 = parseInt(color1.substr(i, 2), 16);
                let c2 = parseInt(color2.substr(i, 2), 16);
                let c = Math.round(c1 + factor * (c2 - c1));
                result += c.toString(16).padStart(2, "0");
            }
            return result;
        }

        function getColorForMetric(value, metric) {
            if (value === null || value === undefined) return '#64748b'; // No Data

            let range;
            if (metric === 'vegetation') range = metricRanges['vegetation_index'];
            else if (metric === 'urban_density') range = metricRanges['urban_density'];
            else if (metric === 'diversity') range = metricRanges['feature_diversity'];
            else if (metric === 'veg_change') range = metricRanges['vegetation_change_percent'];
            else if (metric === 'urban_change') range = metricRanges['urban_density_change_percent'];
            else if (metric === 'diversity_change') range = metricRanges['diversity_change_percent'];

            if (!range || range.min === Infinity) return '#64748b';

            let denominator = range.max - range.min;
            if (denominator === 0) denominator = 1;

            // Normalize 0 to 1
            const normalized = Math.max(0, Math.min(1, (value - range.min) / denominator));

            // Color Scales: 'Best' = Green, 'Worst' = Red
            if (metric === 'vegetation' || metric === 'diversity' || metric === 'veg_change' || metric === 'diversity_change') {
                // Higher is Better (Red -> Green)
                return interpolateColor('#ef4444', '#22c55e', normalized);
            } else if (metric === 'urban_density' || metric === 'urban_change') {
                // Higher is Worse (Good/Green -> Bad/Red)
                // Assuming high urban density is 'bad' in sustainability context
                return interpolateColor('#22c55e', '#ef4444', normalized);
            }

            return '#64748b';
        }

        function getWardColor(wardData, wardId) {
            if (currentMetric === 'status') {
                if (!wardData || !wardData.years || wardData.years.length === 0) return 'rgba(100, 116, 139, 0.1)';
                if (wardData.years.length >= 2) return '#6366f1'; // Both
                if (wardData.years.includes('2024')) return '#22c55e';
                return '#eab308';
            } else {
                const value = getMetricValue(wardId);
                return getColorForMetric(value, currentMetric);
            }
        }

        function toggleLayer(layerName) {
            if (layerName === 'satellite') {
                if (document.getElementById('show-satellite').checked) map.addLayer(satelliteLayer);
                else map.removeLayer(satelliteLayer);
            } else if (layerName === 'osm') {
                if (document.getElementById('show-osm').checked) map.addLayer(osmLayer);
                else map.removeLayer(osmLayer);
            } else if (layerName === 'wards') {
                if (wardLayer) {
                    if (document.getElementById('show-wards').checked) map.addLayer(wardLayer);
                    else map.removeLayer(wardLayer);
                }
            }
        }

        function selectMetric(metric) {
            currentMetric = metric;

            // Update UI Active State
            document.querySelectorAll('.metric-item').forEach(el => el.classList.remove('active'));
            // Find component by its onclick attribute content is tricky, better to use ID or logic
            // But relying on order is brittle. Let's just re-render classes based on metric

            const metrics = ['status', 'vegetation', 'urban_density', 'diversity', 'veg_change', 'urban_change', 'diversity_change'];
            const index = metrics.indexOf(metric);
            if (index >= 0) {
                document.querySelectorAll('.metric-item')[index].classList.add('active');
            }

            if (wardLayer) wardLayer.setStyle(feature => getStyle(feature));
            updateLegend();
        }

        function updateTime(year) {
            currentYear = year;
            if (wardLayer) wardLayer.setStyle(feature => getStyle(feature));
        }

        function updateOpacity(val) {
            if (wardLayer) {
                const opacity = val / 100;
                wardLayer.eachLayer(layer => {
                    layer.setStyle({ fillOpacity: document.getElementById('opacity-slider').value / 100 });
                });
                wardLayer.setStyle(feature => getStyle(feature)); // Force refresh
            }
        }

        function shouldShowWard(wardData) {
            if (!wardData || !wardData.years) return false;
            // If checking status, show all available
            if (currentMetric === 'status') return true;

            // If metric requires pair
            if (currentMetric.includes('change')) {
                return wardData.years.length >= 2;
            }

            if (currentYear === 'both') return wardData.years.length >= 2;
            return wardData.years.includes(currentYear);
        }

        function getStyle(feature) {
            const wardId = feature.properties.KGISWardID;
            const wardData = getWardData(wardId);
            const shouldShow = shouldShowWard(wardData);

            return {
                fillColor: getWardColor(wardData, wardId),
                weight: shouldShow ? 1.5 : 1,
                opacity: shouldShow ? 1 : 0.2, // Border opacity
                color: shouldShow ? '#ffffff' : '#334155', // Border color white if active
                fillOpacity: shouldShow ? (document.getElementById('opacity-slider').value / 100) : 0
            };
        }

        function getWardData(wardId) {
            if (!wardMapping) return null;
            return wardMapping.wards.find(w => w.id === wardId);
        }

        function getDetailedWardData(wardId) {
            if (!detailedAnalysis) return null;
            return detailedAnalysis.wards.find(w => w.ward_id === wardId);
        }

        function loadWards() {
            fetch('bangalore.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';

                    wardLayer = L.geoJSON(data, {
                        pane: 'wardsPane',
                        style: getStyle,
                        onEachFeature: setupWardInteraction
                    }).addTo(map);

                    map.fitBounds(wardLayer.getBounds());
                    updateLegend();
                });
        }

        function updateStats() {
            if (!detailedAnalysis) return;
            document.getElementById('wards-processed').textContent = detailedAnalysis.total_wards_analyzed;
        }

        function setupWardInteraction(feature, layer) {
            const props = feature.properties;

            layer.on({
                mouseover: (e) => {
                    const l = e.target;
                    l.setStyle({ weight: 3, color: '#fbbf24', fillOpacity: 0.9 });
                    l.bringToFront();

                    const wardData = getDetailedWardData(props.KGISWardID);
                    const panel = document.getElementById('ward-info-panel');
                    document.getElementById('info-ward-name').textContent = props.KGISWardName;
                    document.getElementById('info-ward-code').textContent = `Ward ${props.KGISWardNo}`;

                    let content = '';
                    if (wardData) {
                        if (wardData.metrics_2024) {
                            content += `<div class="info-row"><span class="info-label">Vegetation</span><span class="info-value">${wardData.metrics_2024.vegetation_index.toFixed(3)}</span></div>`;
                            content += `<div class="info-row"><span class="info-label">Urban Density</span><span class="info-value">${wardData.metrics_2024.urban_density.toFixed(3)}</span></div>`;
                        } else if (wardData.metrics_2019) {
                            content += `<div class="info-row"><span class="info-label">Vegetation (2019)</span><span class="info-value">${wardData.metrics_2019.vegetation_index.toFixed(3)}</span></div>`;
                        }

                        if (wardData.change_metrics) {
                            const vc = wardData.change_metrics.vegetation_change_percent;
                            content += `<div class="info-row" style="margin-top:8px; border-top:1px solid #334155; padding-top:8px;">
                                <span class="info-label">Veg Change</span>
                                <span class="info-value" style="color: ${getColorForMetric(vc, 'veg_change')}">
                                    ${vc > 0 ? '+' : ''}${vc.toFixed(1)}%
                                </span></div>`;
                        }
                    } else {
                        content = '<div class="info-row" style="color: #94a3b8">No analysis data</div>';
                    }

                    document.getElementById('info-content').innerHTML = content;
                    panel.classList.add('active');
                },
                mouseout: (e) => {
                    wardLayer.resetStyle(e.target);
                    // document.getElementById('ward-info-panel').classList.remove('active'); // Optional: Keep active until click elsewhere?
                    // Usually better to hide
                    document.getElementById('ward-info-panel').classList.remove('active');
                },
                click: (e) => {
                    map.fitBounds(e.target.getBounds());
                }
            });
        }

        function updateLegend() {
            const legendTitle = document.getElementById('legend-title');
            const legendContent = document.getElementById('legend-content');

            // Update title
            const titles = {
                'status': 'Data Status',
                'vegetation': 'Vegetation Index',
                'urban_density': 'Urban Density',
                'diversity': 'Diversity',
                'veg_change': 'Vegetation Change',
                'urban_change': 'Urban Density Change',
                'diversity_change': 'Diversity Change'
            };
            legendTitle.textContent = titles[currentMetric] || 'Legend';

            if (currentMetric !== 'status') {
                // Relative Scale Legend
                let lowLabel = "Low / Worst";
                let highLabel = "High / Best";
                let gradient = "linear-gradient(90deg, #ef4444, #22c55e)"; // Red -> Green

                if (currentMetric === 'urban_density' || currentMetric === 'urban_change') {
                    lowLabel = "Low (Good)";
                    highLabel = "High (Bad)";
                    gradient = "linear-gradient(90deg, #22c55e, #ef4444)"; // Green -> Red
                }

                legendContent.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: #cbd5e1; margin-bottom: 4px;">
                        <span>${lowLabel}</span>
                        <span>${highLabel}</span>
                    </div>
                    <div style="height: 12px; width: 100%; background: ${gradient}; border-radius: 4px; margin-bottom: 8px;"></div>
                    <div style="text-align: center; font-size: 10px; color: #94a3b8;">
                        Relative to current dataset
                    </div>
                 `;
            } else {
                // Status Legend
                legendContent.innerHTML = `
                    <div class="legend-item"><div class="legend-color" style="background: #6366f1;"></div><span>Both Years</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div><span>2024 Only</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #eab308;"></div><span>2019 Only</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #64748b;"></div><span>No Data</span></div>
                 `;
            }
        }
    </script>
</body>

</html>